<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HISAB PREM</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#071117; --accent:#1e6bf0; --green:#24c28b; --red:#ff6b6b; --muted:#98a2a6; --text:#eaf2f5;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg),#041018);color:var(--text);-webkit-font-smoothing:antialiased}

    /* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
    #loginScreen{display:none;position:fixed;inset:0;background:linear-gradient(180deg,#071117,#041018);z-index:500;align-items:center;justify-content:center}
    #loginScreen.show{display:flex}
    .loginCard{background:linear-gradient(180deg,#0b1c24,#0a1820);border-radius:20px;padding:36px 28px;text-align:center;box-shadow:0 28px 80px rgba(0,0,0,0.7);width:92%;max-width:380px}
    .logo-big{font-size:32px;font-weight:800;color:#eaf2f5;letter-spacing:2px;margin-bottom:4px}
    .logo-sub{font-size:13px;color:var(--muted);margin-bottom:28px}

    /* Steps */
    .step{display:none}
    .step.active{display:block}

    .inp{width:100%;padding:14px 16px;border-radius:10px;border:1.5px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.04);color:var(--text);font-size:18px;font-weight:600;margin-top:10px;outline:none;transition:border 0.2s}
    .inp:focus{border-color:var(--accent)}
    .inp::placeholder{color:var(--muted);font-weight:400;font-size:15px}

    .btn{width:100%;padding:14px;border-radius:10px;border:none;font-size:16px;font-weight:700;cursor:pointer;margin-top:14px;transition:opacity 0.2s}
    .btn:active{opacity:0.85}
    .btn-primary{background:linear-gradient(135deg,var(--accent),#1e88e5);color:#fff}
    .btn-green{background:linear-gradient(135deg,var(--green),#13a76b);color:#042216}
    .btn-link{background:transparent;color:var(--muted);font-size:13px;margin-top:6px;padding:8px}

    .err{color:var(--red);font-size:12px;margin-top:10px;min-height:18px}
    .info{color:var(--muted);font-size:13px;margin-top:8px}

    /* reCAPTCHA container */
    #recaptcha-container{margin-top:14px;display:flex;justify-content:center}

    /* Phone flag+input row */
    .phoneRow{display:flex;gap:8px;margin-top:10px}
    .countryCode{width:80px;padding:14px 10px;border-radius:10px;border:1.5px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.04);color:var(--text);font-size:16px;font-weight:700;text-align:center}
    .phoneInp{flex:1;padding:14px 16px;border-radius:10px;border:1.5px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.04);color:var(--text);font-size:18px;font-weight:600;outline:none;transition:border 0.2s}
    .phoneInp:focus{border-color:var(--accent)}
    .phoneInp::placeholder{color:var(--muted);font-weight:400;font-size:15px}

    /* OTP boxes */
    .otpRow{display:flex;gap:10px;justify-content:center;margin-top:14px}
    .otpBox{width:44px;height:52px;border-radius:10px;border:1.5px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.04);color:var(--text);font-size:22px;font-weight:700;text-align:center;outline:none;transition:border 0.2s}
    .otpBox:focus{border-color:var(--accent)}

    /* Timer */
    .timer{font-size:13px;color:var(--muted);margin-top:10px}
    .timer span{color:var(--green);font-weight:700}

    /* ‚îÄ‚îÄ APPBAR ‚îÄ‚îÄ */
    .appbar{display:none;align-items:center;padding:12px 16px;background:linear-gradient(90deg,var(--accent),#1e88e5);box-shadow:0 6px 20px rgba(0,0,0,0.45)}
    .appbar.show{display:flex}
    .logo svg{width:40px;height:40px}
    .title{font-weight:700;font-size:17px;margin-left:8px}
    .appTime{font-weight:600;font-size:13px;color:rgba(255,255,255,0.95);margin-left:auto}
    .userProfile{display:flex;align-items:center;gap:8px;margin-left:12px}
    .userName{font-size:12px;font-weight:600;color:rgba(255,255,255,0.9)}
    .logoutBtn{background:none;border:1px solid rgba(255,255,255,0.3);border-radius:6px;color:#fff;cursor:pointer;font-size:11px;padding:4px 8px;font-weight:600}

    /* ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ */
    #appMain{display:none}
    #appMain.show{display:block}
    .container{max-width:980px;margin:14px auto;padding:0 14px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.03));border-radius:12px;padding:14px;box-shadow:0 10px 36px rgba(0,0,0,0.5)}
    .balanceTitle{font-size:13px;color:#cfeee4}
    .balanceAmt{font-weight:800;font-size:28px;margin-top:6px}
    .ratio{height:10px;background:#081217;border-radius:999px;margin-top:10px;position:relative;overflow:hidden}
    .ratio .ri{height:100%;background:linear-gradient(90deg,var(--green),#16a06f)}
    .ratio .ro{height:100%;background:linear-gradient(90deg,var(--red),#ff7b7b);position:absolute;right:0;top:0}

    .summary{display:flex;gap:8px;margin-top:12px}
    .box{flex:1;padding:10px;border-radius:8px;font-weight:700}
    .box-in{background:rgba(36,194,139,0.12);border:1px solid rgba(36,194,139,0.3);color:var(--green)}
    .box-out{background:rgba(255,107,107,0.12);border:1px solid rgba(255,107,107,0.3);color:var(--red)}
    .box-bal{background:rgba(30,107,240,0.12);border:1px solid rgba(30,107,240,0.3);color:#7eb8ff}
    .box .lbl{font-size:11px;font-weight:600;opacity:0.75}
    .box .val{font-size:17px;font-weight:800;margin-top:4px}

    .chartWrap{margin-top:12px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.01);text-align:center}
    #chartSmall{max-width:200px;max-height:200px;margin:0 auto;display:block}

    .midControls{display:flex;align-items:center;gap:8px;margin-top:12px;flex-wrap:wrap}
    .smallBtn{padding:8px 14px;border-radius:999px;border:none;font-weight:700;cursor:pointer;font-size:14px}
    .smallBtn.in{background:linear-gradient(90deg,var(--green),#12a76a);color:#042216}
    .smallBtn.out{background:linear-gradient(90deg,var(--red),#ef6b6b);color:#2b0f0f}
    .syncStatus{font-size:12px;font-weight:700;margin-left:auto}
    .exportBtn{padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.03);color:var(--text);font-weight:700;cursor:pointer;font-size:13px}

    .list{margin-top:12px;display:flex;flex-direction:column;gap:10px;padding-bottom:100px}
    .tile{display:flex;justify-content:space-between;align-items:flex-start;padding:14px;border-radius:10px;background:linear-gradient(180deg,#071116,#071216);box-shadow:0 6px 18px rgba(0,0,0,0.5);border-left:6px solid transparent}
    .tile.in{border-left-color:var(--green)}
    .tile.out{border-left-color:var(--red)}
    .tileLeft{flex:1;padding-right:10px}
    .tileAmt{font-weight:800;font-size:20px}
    .tileNote{margin-top:5px;font-size:14px;font-weight:600;white-space:pre-wrap}
    .tileMeta{font-size:12px;color:var(--muted);margin-top:6px}
    .tileActions{display:flex;flex-direction:column;gap:8px}
    .iconBtn{width:38px;height:38px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;display:flex;align-items:center;justify-content:center;color:var(--muted);cursor:pointer}
    .iconBtn svg{width:17px;height:17px;stroke:currentColor;fill:none;stroke-width:1.6}

    .fab{position:fixed;right:16px;bottom:18px;width:62px;height:62px;border-radius:50%;background:linear-gradient(135deg,var(--green),#13a76b);display:flex;align-items:center;justify-content:center;color:#042216;font-size:30px;box-shadow:0 16px 40px rgba(15,50,30,0.4);border:3px solid rgba(255,255,255,0.05);cursor:pointer;z-index:200;display:none}
    .fab.show{display:flex}

    .modal{display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.65);z-index:300}
    .modal.open{display:flex}
    .modalCard{width:92%;max-width:500px;background:linear-gradient(180deg,#071417,#07181a);border-radius:14px;padding:18px;box-shadow:0 28px 80px rgba(0,0,0,0.7)}
    .minput{width:100%;padding:14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.03);color:inherit;margin-top:8px;font-size:18px;font-weight:600;outline:none}
    .hidden{display:none!important}
    .sectionTitle{margin-top:18px;font-size:16px;font-weight:700}
  </style>
</head>
<body>

<!-- ‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê -->
<div id="loginScreen" class="show">
  <div class="loginCard">
    <div class="logo-big">HISAB PREM</div>
    <div class="logo-sub">Phone se login karein ‚Äî data safe rahega ‚òÅÔ∏è</div>

    <!-- Step 1: Phone number -->
    <div class="step active" id="step1">
      <div style="font-size:14px;color:var(--muted);text-align:left;margin-bottom:4px">Mobile Number</div>
      <div class="phoneRow">
        <input class="countryCode" id="countryCode" type="text" value="+91" maxlength="4" />
        <input class="phoneInp" id="phoneInp" type="tel" placeholder="10-digit number" maxlength="10" inputmode="numeric" />
      </div>
      <div id="recaptcha-container"></div>
      <button class="btn btn-primary" id="sendOtpBtn">OTP Bhejo üì≤</button>
      <div class="err" id="phoneErr"></div>
    </div>

    <!-- Step 2: OTP -->
    <div class="step" id="step2">
      <div style="font-size:14px;color:var(--muted);margin-bottom:4px">OTP Enter Karein</div>
      <div style="font-size:13px;color:var(--green);margin-bottom:4px" id="otpSentTo"></div>
      <div class="otpRow">
        <input class="otpBox" maxlength="1" inputmode="numeric" type="tel" />
        <input class="otpBox" maxlength="1" inputmode="numeric" type="tel" />
        <input class="otpBox" maxlength="1" inputmode="numeric" type="tel" />
        <input class="otpBox" maxlength="1" inputmode="numeric" type="tel" />
        <input class="otpBox" maxlength="1" inputmode="numeric" type="tel" />
        <input class="otpBox" maxlength="1" inputmode="numeric" type="tel" />
      </div>
      <button class="btn btn-green" id="verifyOtpBtn">Verify & Login ‚úÖ</button>
      <div class="timer" id="timerEl">Resend in <span id="timerCount">60</span>s</div>
      <button class="btn btn-link hidden" id="resendBtn">üîÑ OTP Dobara Bhejo</button>
      <button class="btn btn-link" id="backBtn">‚Üê Wapas Jaao</button>
      <div class="err" id="otpErr"></div>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê APP BAR ‚ïê‚ïê -->
<div class="appbar" id="appbar">
  <div class="logo">
    <svg viewBox="0 0 140 60" xmlns="http://www.w3.org/2000/svg"><g transform="translate(6,6)"><text x="0" y="16" font-family="Inter,Arial" font-size="14" font-weight="700" fill="#fff">HISAB</text><text x="0" y="36" font-family="Inter,Arial" font-size="14" font-weight="700" fill="#fff">PREM</text></g></svg>
  </div>
  <span class="title">HISAB PREM</span>
  <span class="appTime" id="appTime">--:--</span>
  <div class="userProfile">
    <span class="userName" id="userName"></span>
    <button class="logoutBtn" onclick="handleLogout()">Logout</button>
  </div>
</div>

<!-- ‚ïê‚ïê MAIN APP ‚ïê‚ïê -->
<div id="appMain">
  <div class="container">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div class="balanceTitle">Current Balance</div>
          <div class="balanceAmt" id="balanceAmt">‚Çπ0</div>
          <div class="ratio"><div class="ri" id="ratioIn" style="width:50%"></div><div class="ro" id="ratioOut" style="width:50%"></div></div>
        </div>
        <div style="text-align:right;font-size:11px;color:var(--muted)" id="collectionInfo">Loading...</div>
      </div>

      <div class="summary">
        <div class="box box-in"><div class="lbl">Cash In</div><div class="val" id="sumIn">‚Çπ0</div></div>
        <div class="box box-out"><div class="lbl">Cash Out</div><div class="val" id="sumOut">‚Çπ0</div></div>
        <div class="box box-bal"><div class="lbl">Balance</div><div class="val" id="sumBal">‚Çπ0</div></div>
      </div>

      <div class="chartWrap">
        <canvas id="chartSmall" width="150" height="150"></canvas>
      </div>

      <div class="midControls">
        <button class="smallBtn in" id="btnQuickIn">Cash In</button>
        <button class="smallBtn out" id="btnQuickOut">Cash Out</button>
        <div class="syncStatus" id="syncStatus">üîÑ</div>
        <button class="exportBtn" id="exportBtn">üìÑ Export</button>
      </div>
    </div>

    <div id="page-in">
      <div class="sectionTitle">Recent Cash In</div>
      <div id="listIn" class="list"></div>
    </div>
    <div id="page-out" class="hidden">
      <div class="sectionTitle">Recent Cash Out</div>
      <div id="listOut" class="list"></div>
    </div>
  </div>
</div>

<button class="fab" id="fabAdd">+</button>

<!-- Add/Edit Modal -->
<div class="modal" id="modalAdd">
  <div class="modalCard">
    <h3 id="modalTitle" style="margin:0 0 4px">Add Entry</h3>
    <select id="typeSel" class="minput">
      <option value="in">Cash In</option>
      <option value="out">Cash Out</option>
    </select>
    <input id="amtInp" class="minput" type="text" inputmode="decimal" placeholder="Amount (‚Çπ)" />
    <input id="noteInp" class="minput" type="text" placeholder="Note (optional)" />
    <div style="display:flex;gap:10px;margin-top:12px">
      <button id="saveBtn" class="minput" style="background:linear-gradient(135deg,var(--green),#13a76b);color:#042216;font-weight:800;cursor:pointer;border:none">Save</button>
      <button id="cancelBtn" class="minput" style="background:transparent;border:1px solid rgba(255,255,255,0.06);cursor:pointer">Cancel</button>
    </div>
  </div>
</div>

<div id="printArea" style="display:none"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HISAB PREM ‚Äî Phone OTP Login
   Works in WebView + Browser
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ Firebase Init ‚îÄ‚îÄ */
const firebaseConfig = {
  apiKey: "AIzaSyA_prff3ZJmhtt_I2RFfbfJsuym-29O7ng",
  authDomain: "hisabprem.firebaseapp.com",
  projectId: "hisabprem",
  storageBucket: "hisabprem.firebasestorage.app",
  messagingSenderId: "299571413492",
  appId: "1:299571413492:web:de65e2a8d3544060fcb9a1"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

db.enablePersistence({synchronizeTabs:true}).catch(()=>{});

/* ‚îÄ‚îÄ State ‚îÄ‚îÄ */
let currentUser = null;
let entriesIn = [], entriesOut = [];
let editingItem = null;
let unsubIn = null, unsubOut = null;
let confirmationResult = null;
let timerInterval = null;

const LOCAL_IN = 'hp_in', LOCAL_OUT = 'hp_out';

/* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
const qs = s => document.querySelector(s);
const qsa = s => document.querySelectorAll(s);
function nowStr(ts){ return new Date(ts||Date.now()).toLocaleString('en-IN'); }
function safeNum(v){ const n=Number(v); return Number.isFinite(n)?n:null; }
function fmt(n){ return Number(n).toLocaleString('en-IN'); }
function escHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ‚îÄ‚îÄ Local cache ‚îÄ‚îÄ */
function loadLocal(){
  try{
    const a=JSON.parse(localStorage.getItem(LOCAL_IN)||'null');
    const b=JSON.parse(localStorage.getItem(LOCAL_OUT)||'null');
    entriesIn=Array.isArray(a)?a:[];
    entriesOut=Array.isArray(b)?b:[];
  }catch(e){entriesIn=[];entriesOut=[];}
}
function saveLocal(){
  try{
    localStorage.setItem(LOCAL_IN,JSON.stringify(entriesIn));
    localStorage.setItem(LOCAL_OUT,JSON.stringify(entriesOut));
  }catch(e){}
}

/* ‚îÄ‚îÄ Firestore ‚îÄ‚îÄ */
function userCol(type){
  return db.collection('users').doc(currentUser.uid).collection(type==='in'?'entries_in':'entries_out');
}

function subscribeFirestore(){
  if(unsubIn) unsubIn();
  if(unsubOut) unsubOut();
  setSyncStatus('üîÑ','var(--muted)');

  let inReady=false, outReady=false;

  function updateUI(fromCache){
    setSyncStatus(fromCache?'üî¥ Offline':'üü¢ Synced', fromCache?'var(--red)':'var(--green)');
  }

  unsubIn = userCol('in').orderBy('updatedAt','desc')
    .onSnapshot({includeMetadataChanges:true}, snap=>{
      if(snap.metadata.hasPendingWrites) return;
      const seen=new Set();
      entriesIn=snap.docs.map(d=>({...d.data(),id:d.id})).filter(e=>seen.has(e.id)?false:seen.add(e.id));
      saveLocal(); inReady=true;
      if(outReady) updateUI(snap.metadata.fromCache);
      renderAll();
    }, err=>{ setSyncStatus('üî¥ Offline','var(--red)'); loadLocal(); renderAll(); });

  unsubOut = userCol('out').orderBy('updatedAt','desc')
    .onSnapshot({includeMetadataChanges:true}, snap=>{
      if(snap.metadata.hasPendingWrites) return;
      const seen=new Set();
      entriesOut=snap.docs.map(d=>({...d.data(),id:d.id})).filter(e=>seen.has(e.id)?false:seen.add(e.id));
      saveLocal(); outReady=true;
      if(inReady) updateUI(snap.metadata.fromCache);
      renderAll();
    }, err=>{});
}

function setSyncStatus(txt,color){
  const el=qs('#syncStatus');
  el.textContent=txt;
  el.style.color=color;
}

/* ‚îÄ‚îÄ Render ‚îÄ‚îÄ */
function tileHTML(e){
  const cls=e.type==='out'?'out':'in';
  return `<div class="tile ${cls}" data-id="${e.id}">
    <div class="tileLeft">
      <div class="tileAmt">‚Çπ${fmt(e.amount||0)}</div>
      <div class="tileNote">${escHtml(e.note)||'&nbsp;'}</div>
      <div class="tileMeta">${escHtml(e.date||nowStr())}</div>
    </div>
    <div class="tileActions">
      <button class="iconBtn" onclick="openEdit('${e.id}','${e.type}')">
        <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <button class="iconBtn" onclick="deleteEntry('${e.id}','${e.type}')">
        <svg viewBox="0 0 24 24"><path d="M3 6h18" stroke-linecap="round"/><path d="M8 6v14a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6" stroke-linecap="round"/></svg>
      </button>
    </div>
  </div>`;
}

function renderLists(){
  qs('#listIn').innerHTML = entriesIn.length ? entriesIn.map(tileHTML).join('') : '<div style="color:var(--muted);padding:12px">Koi entry nahi</div>';
  qs('#listOut').innerHTML = entriesOut.length ? entriesOut.map(tileHTML).join('') : '<div style="color:var(--muted);padding:12px">Koi entry nahi</div>';
}

function renderSummary(){
  const tIn=entriesIn.reduce((s,x)=>s+(Number(x.amount)||0),0);
  const tOut=entriesOut.reduce((s,x)=>s+(Number(x.amount)||0),0);
  qs('#sumIn').textContent='‚Çπ'+fmt(tIn);
  qs('#sumOut').textContent='‚Çπ'+fmt(tOut);
  qs('#sumBal').textContent='‚Çπ'+fmt(tIn-tOut);
  qs('#balanceAmt').textContent='‚Çπ'+fmt(tIn-tOut);
  const tot=(tIn+tOut)||1;
  qs('#ratioIn').style.width=Math.round((tIn/tot)*100)+'%';
  qs('#ratioOut').style.width=Math.round((tOut/tot)*100)+'%';
}

function renderChart(){
  try{
    const ctx=qs('#chartSmall').getContext('2d');
    const tIn=entriesIn.reduce((s,x)=>s+(Number(x.amount)||0),0);
    const tOut=entriesOut.reduce((s,x)=>s+(Number(x.amount)||0),0);
    if(window._donut) window._donut.destroy();
    window._donut=new Chart(ctx,{
      type:'doughnut',
      data:{labels:['Cash In','Cash Out'],datasets:[{data:[tIn,tOut],backgroundColor:['#24c28b','#ff6b6b']}]},
      options:{responsive:false,maintainAspectRatio:false,cutout:'70%',plugins:{legend:{display:false}}}
    });
  }catch(e){}
}

function renderAll(){ renderSummary(); renderLists(); renderChart(); }

/* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
function openAdd(type='in'){
  editingItem=null;
  qs('#modalTitle').textContent='Add Entry';
  qs('#typeSel').value=type;
  qs('#amtInp').value='';
  qs('#noteInp').value='';
  qs('#amtInp').removeAttribute('data-result');
  qs('#modalAdd').classList.add('open');
  document.body.style.overflow='hidden';
  setTimeout(()=>qs('#amtInp').focus(),80);
}

function openEdit(id,type){
  const list=type==='in'?entriesIn:entriesOut;
  const e=list.find(x=>String(x.id)===String(id));
  if(!e) return;
  editingItem={id:e.id,type};
  qs('#modalTitle').textContent='Edit Entry';
  qs('#typeSel').value=type;
  qs('#amtInp').value=String(e.amount||'');
  qs('#noteInp').value=e.note||'';
  qs('#modalAdd').classList.add('open');
  document.body.style.overflow='hidden';
  setTimeout(()=>qs('#amtInp').focus(),80);
}

function closeModal(){
  qs('#modalAdd').classList.remove('open');
  editingItem=null;
  document.body.style.overflow='';
}

async function saveEntry(){
  let amtVal=qs('#amtInp').value||'';
  const dr=qs('#amtInp').getAttribute('data-result');
  if(dr) amtVal=dr;
  const amt=safeNum(amtVal);
  const note=(qs('#noteInp').value||'').trim();
  const type=qs('#typeSel').value==='out'?'out':'in';
  if(!amt||amt<=0){qs('#amtInp').focus();return;}

  const saveBtn=qs('#saveBtn');
  saveBtn.disabled=true; saveBtn.textContent='Saving...';

  const now=Date.now();
  try{
    if(editingItem){
      const oldList=editingItem.type==='in'?entriesIn:entriesOut;
      const old=oldList.find(x=>String(x.id)===String(editingItem.id));
      const obj={amount:amt,note,date:old?old.date:nowStr(now),updatedAt:now,type};
      if(editingItem.type!==type){
        const batch=db.batch();
        batch.delete(userCol(editingItem.type).doc(String(editingItem.id)));
        batch.set(userCol(type).doc(),obj);
        await batch.commit();
      } else {
        await userCol(type).doc(String(editingItem.id)).set(obj);
      }
    } else {
      await userCol(type).add({amount:amt,note,date:nowStr(now),updatedAt:now,type});
    }
    setSyncStatus('üü¢ Saved','var(--green)');
  }catch(err){
    // Offline fallback
    if(editingItem){
      const oldList=editingItem.type==='in'?entriesIn:entriesOut;
      const old=oldList.find(x=>String(x.id)===String(editingItem.id));
      const obj={amount:amt,note,date:old?old.date:nowStr(now),updatedAt:now,type,id:editingItem.id};
      if(editingItem.type==='in') entriesIn=entriesIn.filter(x=>String(x.id)!==String(editingItem.id));
      else entriesOut=entriesOut.filter(x=>String(x.id)!==String(editingItem.id));
      if(type==='in') entriesIn.unshift(obj); else entriesOut.unshift(obj);
    } else {
      const obj={amount:amt,note,date:nowStr(now),updatedAt:now,type,id:String(now)};
      if(type==='in') entriesIn.unshift(obj); else entriesOut.unshift(obj);
    }
    saveLocal(); renderAll();
    setSyncStatus('üî¥ Offline','var(--red)');
  }
  saveBtn.disabled=false; saveBtn.textContent='Save';
  closeModal();
}

async function deleteEntry(id,type){
  if(!confirm('Delete karein?')) return;
  try{
    await userCol(type).doc(String(id)).delete();
    setSyncStatus('üü¢ Deleted','var(--green)');
  }catch(err){
    if(type==='in') entriesIn=entriesIn.filter(x=>String(x.id)!==String(id));
    else entriesOut=entriesOut.filter(x=>String(x.id)!==String(id));
    saveLocal(); renderAll();
  }
}

/* ‚îÄ‚îÄ Amount field ‚îÄ‚îÄ */
qs('#amtInp').addEventListener('keydown',e=>{
  const ok=['Backspace','Delete','Tab','Escape','Enter','ArrowLeft','ArrowRight','Home','End'];
  if(ok.includes(e.key)) return;
  if((e.ctrlKey||e.metaKey)&&['a','c','v','x'].includes(e.key.toLowerCase())) return;
  if(!/^[0-9+\-*\/.()\s]$/.test(e.key)) e.preventDefault();
});
qs('#amtInp').addEventListener('input',e=>{
  const cleaned=e.target.value.replace(/[^0-9+\-*\/.()\s]/g,'');
  if(cleaned!==e.target.value) e.target.value=cleaned;
  try{
    if(/^[0-9+\-*/.() ]+$/.test(cleaned)){
      const r=Function('return '+cleaned)();
      if(isFinite(r)) e.target.setAttribute('data-result',r);
      else e.target.removeAttribute('data-result');
    } else e.target.removeAttribute('data-result');
  }catch{e.target.removeAttribute('data-result');}
});
qs('#amtInp').addEventListener('blur',e=>{
  const r=e.target.getAttribute('data-result');
  if(r){ const n=Number(r); e.target.value=Number.isInteger(n)?String(n):String(Math.round(n*100)/100); }
});

/* ‚îÄ‚îÄ Navigate ‚îÄ‚îÄ */
window.navigate=function(p){
  if(p==='out'){
    qs('#page-in').classList.add('hidden');
    qs('#page-out').classList.remove('hidden');
  } else {
    qs('#page-out').classList.add('hidden');
    qs('#page-in').classList.remove('hidden');
  }
};

/* ‚îÄ‚îÄ Show/Hide App ‚îÄ‚îÄ */
function showApp(user){
  currentUser=user;
  qs('#loginScreen').classList.remove('show');
  qs('#appbar').classList.add('show');
  qs('#appMain').classList.add('show');
  qs('#fabAdd').classList.add('show');
  qs('#userName').textContent=user.phoneNumber||'User';
  qs('#collectionInfo').textContent=user.phoneNumber||'';
  loadLocal(); renderAll();
  subscribeFirestore();
}

function showLogin(){
  currentUser=null;
  if(unsubIn){unsubIn();unsubIn=null;}
  if(unsubOut){unsubOut();unsubOut=null;}
  qs('#loginScreen').classList.add('show');
  qs('#appbar').classList.remove('show');
  qs('#appMain').classList.remove('show');
  qs('#fabAdd').classList.remove('show');
  // Reset login form
  qs('#step1').classList.add('active');
  qs('#step2').classList.remove('active');
  qs('#phoneInp').value='';
  qs('#phoneErr').textContent='';
}

window.handleLogout=function(){
  auth.signOut().then(()=>showLogin()).catch(()=>{});
};

/* ‚îÄ‚îÄ OTP Boxes auto-focus ‚îÄ‚îÄ */
const otpBoxes=qsa('.otpBox');
otpBoxes.forEach((box,i)=>{
  box.addEventListener('input',e=>{
    // Only numbers
    e.target.value=e.target.value.replace(/\D/g,'');
    if(e.target.value && i<otpBoxes.length-1) otpBoxes[i+1].focus();
  });
  box.addEventListener('keydown',e=>{
    if(e.key==='Backspace'&&!e.target.value&&i>0) otpBoxes[i-1].focus();
  });
  box.addEventListener('paste',e=>{
    e.preventDefault();
    const text=(e.clipboardData||window.clipboardData).getData('text').replace(/\D/g,'');
    text.split('').forEach((ch,j)=>{ if(otpBoxes[i+j]) otpBoxes[i+j].value=ch; });
    const next=Math.min(i+text.length,otpBoxes.length-1);
    otpBoxes[next].focus();
  });
});

function getOTP(){
  return Array.from(otpBoxes).map(b=>b.value).join('');
}
function clearOTP(){
  otpBoxes.forEach(b=>b.value='');
  otpBoxes[0].focus();
}

/* ‚îÄ‚îÄ Timer ‚îÄ‚îÄ */
function startTimer(sec=60){
  clearInterval(timerInterval);
  qs('#timerEl').classList.remove('hidden');
  qs('#resendBtn').classList.add('hidden');
  qs('#timerCount').textContent=sec;
  timerInterval=setInterval(()=>{
    sec--;
    qs('#timerCount').textContent=sec;
    if(sec<=0){
      clearInterval(timerInterval);
      qs('#timerEl').classList.add('hidden');
      qs('#resendBtn').classList.remove('hidden');
    }
  },1000);
}

/* ‚îÄ‚îÄ reCAPTCHA (invisible) ‚îÄ‚îÄ */
function setupRecaptcha(){
  if(window.recaptchaVerifier){
    try{ window.recaptchaVerifier.clear(); }catch(e){}
  }
  qs('#recaptcha-container').innerHTML='';
  window.recaptchaVerifier=new firebase.auth.RecaptchaVerifier('recaptcha-container',{
    size:'invisible',
    callback:()=>{}
  });
}

/* ‚îÄ‚îÄ Send OTP ‚îÄ‚îÄ */
qs('#sendOtpBtn').addEventListener('click',async()=>{
  const phone=qs('#phoneInp').value.trim().replace(/\D/g,'');
  const code=qs('#countryCode').value.trim()||'+91';
  const errEl=qs('#phoneErr');
  errEl.textContent='';

  if(phone.length!==10){ errEl.textContent='Sahi 10-digit number daalo'; return; }

  const fullPhone=code+phone;
  qs('#sendOtpBtn').disabled=true;
  qs('#sendOtpBtn').textContent='Bhej raha hoon...';

  try{
    setupRecaptcha();
    confirmationResult=await auth.signInWithPhoneNumber(fullPhone,window.recaptchaVerifier);
    // Show step 2
    qs('#step1').classList.remove('active');
    qs('#step2').classList.add('active');
    qs('#otpSentTo').textContent='OTP bheja: '+fullPhone;
    startTimer(60);
    clearOTP();
  }catch(err){
    console.error('OTP send error',err);
    errEl.textContent=getFirebaseErrMsg(err);
    setupRecaptcha(); // reset
  }
  qs('#sendOtpBtn').disabled=false;
  qs('#sendOtpBtn').textContent='OTP Bhejo üì≤';
});

/* ‚îÄ‚îÄ Verify OTP ‚îÄ‚îÄ */
qs('#verifyOtpBtn').addEventListener('click',async()=>{
  const otp=getOTP();
  const errEl=qs('#otpErr');
  errEl.textContent='';
  if(otp.length!==6){ errEl.textContent='6-digit OTP daalo'; return; }
  if(!confirmationResult){ errEl.textContent='Pehle OTP mangao'; return; }

  qs('#verifyOtpBtn').disabled=true;
  qs('#verifyOtpBtn').textContent='Verify ho raha hai...';

  try{
    await confirmationResult.confirm(otp);
    // onAuthStateChanged will fire and showApp()
  }catch(err){
    console.error('OTP verify error',err);
    errEl.textContent=getFirebaseErrMsg(err);
    qs('#verifyOtpBtn').disabled=false;
    qs('#verifyOtpBtn').textContent='Verify & Login ‚úÖ';
  }
});

/* ‚îÄ‚îÄ Resend OTP ‚îÄ‚îÄ */
qs('#resendBtn').addEventListener('click',async()=>{
  qs('#resendBtn').classList.add('hidden');
  qs('#otpErr').textContent='';
  const phone=qs('#phoneInp').value.trim().replace(/\D/g,'');
  const code=qs('#countryCode').value.trim()||'+91';
  const fullPhone=code+phone;
  try{
    setupRecaptcha();
    confirmationResult=await auth.signInWithPhoneNumber(fullPhone,window.recaptchaVerifier);
    startTimer(60);
    clearOTP();
    qs('#otpErr').textContent='';
  }catch(err){
    qs('#otpErr').textContent=getFirebaseErrMsg(err);
    qs('#resendBtn').classList.remove('hidden');
  }
});

/* ‚îÄ‚îÄ Back button ‚îÄ‚îÄ */
qs('#backBtn').addEventListener('click',()=>{
  clearInterval(timerInterval);
  qs('#step2').classList.remove('active');
  qs('#step1').classList.add('active');
  qs('#phoneErr').textContent='';
  qs('#otpErr').textContent='';
});

/* ‚îÄ‚îÄ Firebase error messages in Hindi ‚îÄ‚îÄ */
function getFirebaseErrMsg(err){
  const code=err.code||'';
  const msgs={
    'auth/invalid-phone-number':'Phone number galat hai',
    'auth/too-many-requests':'Bahut zyada requests. Thodi der baad try karo',
    'auth/invalid-verification-code':'OTP galat hai. Dobara try karo',
    'auth/code-expired':'OTP expire ho gaya. Dobara bhejo',
    'auth/missing-phone-number':'Phone number daalo',
    'auth/quota-exceeded':'SMS limit khatam. Kal try karo',
    'auth/captcha-check-failed':'reCAPTCHA failed. Page refresh karo',
    'auth/network-request-failed':'Internet check karo',
  };
  return msgs[code]||('Error: '+err.message);
}

/* ‚îÄ‚îÄ Auth State ‚îÄ‚îÄ */
auth.onAuthStateChanged(user=>{
  if(user) showApp(user);
  else showLogin();
});

/* ‚îÄ‚îÄ Export PDF ‚îÄ‚îÄ */
async function exportPDF(){
  const combined=(entriesIn||[]).concat(entriesOut||[]);
  if(!combined.length){alert('Koi entry nahi');return;}
  const print=qs('#printArea');
  print.innerHTML='';
  const c=document.createElement('div');
  c.style.cssText='width:720px;background:#fff;padding:18px;border:4px solid #1e6bf0;border-radius:8px;box-sizing:border-box;color:#111;font-family:Arial,sans-serif;font-size:12px';
  const tIn=entriesIn.reduce((s,x)=>s+Number(x.amount||0),0);
  const tOut=entriesOut.reduce((s,x)=>s+Number(x.amount||0),0);
  c.innerHTML=`
    <div style="display:flex;justify-content:space-between;margin-bottom:12px">
      <div style="font-size:22px;font-weight:800;color:#0b3db8">HISAB PREM</div>
      <div style="text-align:right"><div style="font-weight:700;color:#0b3db8">Account Statement</div>
      <div style="font-size:11px;color:#333">${currentUser?currentUser.phoneNumber:''}</div>
      <div style="font-size:11px;color:#333">${new Date().toLocaleString('en-IN')}</div></div>
    </div>
    <div style="display:flex;gap:10px;margin-bottom:12px">
      <div style="flex:1;padding:10px;background:#f7fff7;border:1px solid #c8f5e0;border-radius:6px;text-align:center"><div style="font-size:11px;color:#444">Cash In</div><div style="font-weight:700">‚Çπ${tIn.toLocaleString('en-IN')}</div></div>
      <div style="flex:1;padding:10px;background:#fff7f7;border:1px solid #ffd0d0;border-radius:6px;text-align:center"><div style="font-size:11px;color:#444">Cash Out</div><div style="font-weight:700">‚Çπ${tOut.toLocaleString('en-IN')}</div></div>
      <div style="flex:1;padding:10px;background:#f0f6ff;border:1px solid #cce0ff;border-radius:6px;text-align:center"><div style="font-size:11px;color:#444">Balance</div><div style="font-weight:700">‚Çπ${(tIn-tOut).toLocaleString('en-IN')}</div></div>
    </div>
    <table style="width:100%;border-collapse:collapse;font-size:12px">
      <thead><tr style="background:#f0f6ff">
        <th style="border:1px solid #dde;padding:6px;text-align:left">Date</th>
        <th style="border:1px solid #dde;padding:6px;text-align:left">Type</th>
        <th style="border:1px solid #dde;padding:6px;text-align:right">Amount</th>
        <th style="border:1px solid #dde;padding:6px;text-align:left">Note</th>
      </tr></thead>
      <tbody>${
        [...(entriesIn||[]).map(e=>({...e,_t:'Cash In'})),...(entriesOut||[]).map(e=>({...e,_t:'Cash Out'}))]
        .sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0))
        .map(r=>`<tr>
          <td style="border:1px solid #eef;padding:6px">${escHtml(r.date)}</td>
          <td style="border:1px solid #eef;padding:6px">${r._t}</td>
          <td style="border:1px solid #eef;padding:6px;text-align:right">‚Çπ${Number(r.amount).toLocaleString('en-IN')}</td>
          <td style="border:1px solid #eef;padding:6px">${escHtml(r.note||'')}</td>
        </tr>`).join('')
      }</tbody>
    </table>
    <div style="margin-top:12px;font-size:11px;color:#666;text-align:center">Generated by HISAB PREM</div>`;
  print.appendChild(c);
  print.style.display='block';
  await html2pdf().set({margin:[8,8,8,8],filename:'HISAB_PREM.pdf',html2canvas:{scale:2},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}}).from(c).save();
  print.style.display='none';
  print.innerHTML='';
}

/* ‚îÄ‚îÄ Live time ‚îÄ‚îÄ */
function tickTime(){ qs('#appTime').textContent=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:true}); }
setInterval(tickTime,1000); tickTime();

/* ‚îÄ‚îÄ UI Bindings ‚îÄ‚îÄ */
window.openEdit=openEdit;
window.deleteEntry=deleteEntry;

qs('#fabAdd').addEventListener('click',()=>openAdd('in'));
qs('#btnQuickIn').addEventListener('click',()=>navigate('in'));
qs('#btnQuickOut').addEventListener('click',()=>navigate('out'));
qs('#cancelBtn').addEventListener('click',closeModal);
qs('#saveBtn').addEventListener('click',saveEntry);
qs('#modalAdd').addEventListener('click',e=>{ if(e.target===qs('#modalAdd')) closeModal(); });
document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeModal(); });
qs('#exportBtn').addEventListener('click',exportPDF);

window.addEventListener('online',()=>{ if(currentUser) subscribeFirestore(); });
window.addEventListener('offline',()=>setSyncStatus('üî¥ Offline','var(--red)'));

/* Phone input ‚Äî only numbers */
qs('#phoneInp').addEventListener('input',e=>{
  e.target.value=e.target.value.replace(/\D/g,'');
});
</script>
</body>
</html>
