<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hybrid Finance Manager Pro</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #3b82f6; --red: #ef4444; --green: #22c55e; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; }
        header { background: var(--card); padding: 15px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        .card { background: var(--card); padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #334155; }
        input, select { padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #334155; width: 100%; background: #0f172a; color: white; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; background: var(--accent); color: white; font-weight: bold; font-size: 16px; }
        .summary { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: #111827; padding: 12px; border-radius: 8px; text-align: center; }
        .income { color: var(--green); } .expense { color: var(--red); }
        .transaction-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; padding: 10px 0; }
        .btn-group { display: flex; gap: 5px; }
        .btn-small { padding: 5px 10px; font-size: 12px; width: auto; }
        #loginOverlay { position: fixed; inset: 0; background: var(--bg); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 9999; padding: 20px; text-align: center; }
        #status { font-size: 12px; color: #94a3b8; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <h1>ðŸ’° Hisab Prem</h1>
    <p>Cloud sync enabled accounting</p>
    <button id="googleLoginBtn">Login with Google</button>
</div>

<header>
    Hybrid Finance Manager
    <div id="status">Syncing...</div>
</header>

<div class="container">
    <div class="summary">
        <div class="stat-box">Balance<br><b id="balance">â‚¹0</b></div>
        <div class="stat-box">Income<br><b id="totalIncome" class="income">â‚¹0</b></div>
    </div>

    <div class="card">
        <h3>Add Transaction</h3>
        <input id="desc" placeholder="Kahan kharch kiya?">
        <input id="amount" type="number" inputmode="decimal" placeholder="Amount (â‚¹)">
        <select id="type">
            <option value="expense">Expense (-)</option>
            <option value="income">Income (+)</option>
        </select>
        <button onclick="addTransaction()">Save Entry</button>
    </div>

    <div class="card">
        <input id="search" placeholder="Search transactions..." oninput="render()">
        <div id="transactionList"></div>
    </div>
    
    <button onclick="logout()" style="background:#334155; margin-top:20px;">Logout</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA_prff3ZJmhtt_I2RFfbfJsuym-29O7ng",
        authDomain: "hisabprem.firebaseapp.com",
        projectId: "hisabprem",
        storageBucket: "hisabprem.firebasestorage.app",
        messagingSenderId: "299571413492",
        appId: "1:299571413492:web:de65e2a8d3544060fcb9a1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let transactions = [];

    // --- Auth Logic ---
    document.getElementById("googleLoginBtn").onclick = () => signInWithRedirect(auth, provider);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById("loginOverlay").classList.add("hidden");
            startSync();
        } else {
            document.getElementById("loginOverlay").classList.remove("hidden");
        }
    });

    window.logout = () => { if(confirm("Logout?")) signOut(auth).then(()=>location.reload()); };

    // --- Sync Logic ---
    function startSync() {
        const q = query(collection(db, "users", currentUser.uid, "transactions"), orderBy("updatedAt", "desc"));
        onSnapshot(q, (snapshot) => {
            transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            render();
            document.getElementById("status").innerText = "Cloud Synced";
        }, (err) => {
            console.error(err);
            document.getElementById("status").innerText = "Permission Denied (Check Rules)";
        });
    }

    // --- UI Logic ---
    window.render = function() {
        const list = document.getElementById("transactionList");
        const search = document.getElementById("search").value.toLowerCase();
        list.innerHTML = "";
        
        let inc = 0, exp = 0;
        transactions.filter(t => t.desc.toLowerCase().includes(search)).forEach(t => {
            const isInc = t.type === "income";
            if(isInc) inc += Number(t.amount); else exp += Number(t.amount);

            const div = document.createElement("div");
            div.className = "transaction-item";
            div.innerHTML = `
                <div>
                    <b>${t.desc}</b><br>
                    <small class="${isInc?'income':'expense'}">${isInc?'+':'-'}â‚¹${t.amount}</small>
                </div>
                <div class="btn-group">
                    <button class="btn-small" style="background:var(--red)" onclick="deleteEntry('${t.id}')">âœ•</button>
                </div>
            `;
            list.appendChild(div);
        });

        document.getElementById("totalIncome").innerText = `â‚¹${inc}`;
        document.getElementById("balance").innerText = `â‚¹${inc - exp}`;
    }

    // --- Action Logic ---
    window.addTransaction = async function() {
        const desc = document.getElementById("desc").value;
        const amount = document.getElementById("amount").value;
        const type = document.getElementById("type").value;

        if (!desc || !amount) return alert("Details bharo bhai!");

        const id = Date.now().toString();
        const data = { id, desc, amount, type, updatedAt: Date.now() };

        try {
            await setDoc(doc(db, "users", currentUser.uid, "transactions", id), data);
            document.getElementById("desc").value = "";
            document.getElementById("amount").value = "";
        } catch (e) {
            alert("Error: " + e.message);
        }
    }

    window.deleteEntry = async function(id) {
        if(confirm("Delete karein?")) {
            await deleteDoc(doc(db, "users", currentUser.uid, "transactions", id));
        }
    }
</script>
</body>
</html>
