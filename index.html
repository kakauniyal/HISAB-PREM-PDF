<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HISAB PREM ‚Äî Cloud Sync</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#071117; --card:#0b1113; --accent:#1e6bf0; --green:#24c28b; --red:#ff6b6b; --muted:#98a2a6; --text:#eaf2f5;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg),#041018);color:var(--text);-webkit-font-smoothing:antialiased}
    
    /* Login Overlay - Custom Added */
    #loginOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; text-align: center; }
    .loginCard { background: var(--card); padding: 40px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); width: 90%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }

    .appbar{display:flex;align-items:center;padding:12px 16px;background:linear-gradient(90deg,var(--accent),#1e88e5);box-shadow:0 6px 20px rgba(0,0,0,0.45)}
    .logo{display:flex;align-items:center;gap:10px}
    .logo svg{width:44px;height:44px}
    .title{font-weight:700;font-size:18px}
    .time{margin-left:auto;font-weight:600;font-size:13px;color:rgba(255,255,255,0.95)}
    .container{max-width:980px;margin:14px auto;padding:0 16px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));border-radius:12px;padding:14px;box-shadow:0 10px 36px rgba(0,0,0,0.5)}
    .balanceRow{display:flex;gap:16px;align-items:center}
    .balanceLeft{flex:1}
    .balanceTitle{font-size:13px;color:#cfeee4}
    .balanceAmt{font-weight:800;font-size:28px;margin-top:6px}
    .ratio{height:12px;background:#081217;border-radius:999px;margin-top:10px;position:relative;overflow:hidden}
    .ratio .in{height:100%;background:linear-gradient(90deg,var(--green),#16a06f);width:50%}
    .ratio .out{height:100%;background:linear-gradient(90deg,var(--red),#ff7b7b);position:absolute;right:0;top:0;width:50%}
    .summary{display:flex;gap:10px;margin-top:12px}
    .summary .box{flex:1;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);font-weight:700}
    .chartWrap{margin-top:12px;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03))}
    #chartSmall{width:100%;height:100%;display:block; max-width:300px; max-height:300px; margin:0 auto;}

    .midControls{display:flex;align-items:center;gap:10px;margin-top:12px}
    .smallBtn{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);font-weight:700;cursor:pointer}
    .smallBtn.in{background:linear-gradient(90deg,var(--green),#12a76a);color:#042216}
    .smallBtn.out{background:linear-gradient(90deg,var(--red),#ef6b6b);color:#2b0f0f}
    .syncStatus{margin-left:auto;font-size:13px;color:var(--muted);font-weight:600}
    .exportBtn{padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02);color:var(--text);font-weight:700;cursor:pointer;margin-left:8px}

    .list{margin-top:14px;display:flex;flex-direction:column;gap:12px;padding-bottom:120px}
    .tile{display:flex;justify-content:space-between;align-items:flex-start;padding:14px;border-radius:10px;background:linear-gradient(180deg,#071116,#071216);box-shadow:0 8px 22px rgba(0,0,0,0.6);border-left:8px solid transparent}
    .amount{font-weight:800;font-size:20px}
    .note{margin-top:6px;font-weight:700;font-size:14px;color:var(--text);white-space:pre-wrap}
    .meta small{display:block;color:var(--muted);margin-top:8px}
    .tile.in{border-left-color:var(--green)}
    .tile.out{border-left-color:var(--red)}
    .iconBtn{width:40px;height:40px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;display:flex;align-items:center;justify-content:center;color:var(--muted);cursor:pointer}
    .iconBtn svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:1.6}

    .fab{position:fixed;right:16px;bottom:18px;width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--green),#13a76b);display:flex;align-items:center;justify-content:center;color:#042216;font-size:32px;box-shadow:0 18px 48px rgba(15,50,30,0.35);border:4px solid rgba(255,255,255,0.03);cursor:pointer;z-index:200}
    .modal{display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.8);z-index:300}
    .modalCard{width:92%;max-width:520px;background:linear-gradient(180deg,#071417,#07181a);border-radius:12px;padding:16px;box-shadow:0 28px 80px rgba(0,0,0,0.7)}
    .input{width:100%;padding:14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.03);color:inherit;margin-top:8px;font-size:18px;font-weight:600}
    .hidden{display:none!important}
  </style>
</head>
<body>

  <div id="loginOverlay">
    <div class="loginCard">
      <h1 style="margin:0; color:var(--accent)">HISAB PREM</h1>
      <p style="color:var(--muted)">Apna data cloud par surakshit rakhein</p>
      <button class="smallBtn in" style="width:100%; margin-top:20px; padding:15px;" onclick="login()">Login with Google</button>
    </div>
  </div>

  <div id="appContent" class="hidden">
    <div class="appbar">
      <div class="logo">
        <svg viewBox="0 0 140 60" xmlns="http://www.w3.org/2000/svg"><g transform="translate(6,6)"><text x="0" y="16" font-family="Inter, Arial" font-size="14" font-weight="700" fill="#fff">HISAB</text><text x="0" y="36" font-family="Inter, Arial" font-size="14" font-weight="700" fill="#fff">PREM</text></g></svg>
      </div>
      <div style="margin-left:10px">
        <div class="title">HISAB PREM</div>
        <div id="userDisplay" style="font-size:12px;color:rgba(255,255,255,0.95)">Cloud Sync Active</div>
      </div>
      <button onclick="logout()" style="margin-left:auto; background:transparent; border:1px solid #fff; color:#fff; border-radius:4px; padding:2px 8px; font-size:10px;">Logout</button>
      <div class="time" id="appTime">--:--</div>
    </div>

    <div class="container">
      <div class="card">
        <div class="balanceRow">
          <div class="balanceLeft">
            <div class="balanceTitle">Current Balance</div>
            <div id="balanceAmt" class="balanceAmt">‚Çπ0</div>
            <div class="ratio"><div id="ratioIn" class="in" style="width:50%"></div><div id="ratioOut" class="out" style="width:50%"></div></div>
          </div>
        </div>

        <div class="summary">
          <div class="box">Cash In<br/><div id="sumIn" style="font-size:18px;margin-top:6px; color:var(--green)">‚Çπ0</div></div>
          <div class="box">Cash Out<br/><div id="sumOut" style="font-size:18px;margin-top:6px; color:var(--red)">‚Çπ0</div></div>
          <div class="box">Balance<br/><div id="sumBal" style="font-size:18px;margin-top:6px">‚Çπ0</div></div>
        </div>

        <div class="chartWrap">
          <canvas id="chartSmall"></canvas>
        </div>

        <div class="midControls">
          <button class="smallBtn in" onclick="navigate('in')">View In</button>
          <button class="smallBtn out" onclick="navigate('out')">View Out</button>
          <div class="syncStatus" id="syncStatus">Cloud Syncing...</div>
          <button id="exportBtn" class="exportBtn" onclick="exportPDF()">üìÑ PDF</button>
        </div>
      </div>

      <div id="page-in" class="page">
        <h3 style="margin-top:18px">Cash In Entries</h3>
        <div id="listIn" class="list"></div>
      </div>

      <div id="page-out" class="page hidden">
        <h3 style="margin-top:18px">Cash Out Entries</h3>
        <div id="listOut" class="list"></div>
      </div>
    </div>

    <button class="fab" onclick="openAdd('in')">+</button>

    <div class="modal" id="modalAdd">
      <div class="modalCard">
        <h3 id="modalTitle">Naya Hisab</h3>
        <select id="typeSel" class="input">
          <option value="in">Cash In</option>
          <option value="out">Cash Out</option>
        </select>
        <input id="amtInp" class="input" type="text" placeholder="Amount (‚Çπ) / Calculation" />
        <input id="noteInp" class="input" type="text" placeholder="Note (Dukaan, Rent, etc.)" />
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
          <button onclick="saveEntry()" class="input" style="background:var(--green); color:#000; font-weight:800">Save Online</button>
          <button onclick="closeModal()" class="input" style="background:#333; color:#fff">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div id="printArea" style="display:none"></div>

  <script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyA_prff3ZJmhtt_I2RFfbfJsuym-29O7ng",
      authDomain: "hisabprem.firebaseapp.com",
      projectId: "hisabprem",
      storageBucket: "hisabprem.firebasestorage.app",
      messagingSenderId: "299571413492",
      appId: "1:299571413492:web:de65e2a8d3544060fcb9a1",
      measurementId: "G-6DJE8XPXQ5"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let entries = [];
    let myChart = null;
    let editingItem = null;

    // --- AUTH LOGIC ---
    function login() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(e => alert("Login Error: " + e.message));
    }

    function logout() {
      auth.signOut().then(() => location.reload());
    }

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        document.getElementById('loginOverlay').classList.add('hidden');
        document.getElementById('appContent').classList.remove('hidden');
        document.getElementById('userDisplay').textContent = user.displayName;
        listenToData();
      } else {
        document.getElementById('loginOverlay').classList.remove('hidden');
        document.getElementById('appContent').classList.add('hidden');
      }
    });

    // --- DATA LOGIC ---
    function listenToData() {
      db.collection('user_hisab')
        .where('userId', '==', currentUser.uid)
        .orderBy('timestamp', 'desc')
        .onSnapshot(snapshot => {
          entries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          renderAll();
          document.getElementById('syncStatus').textContent = 'Cloud Active';
        }, err => {
          console.error(err);
          // If index error, fallback to simple query
          db.collection('user_hisab').where('userId', '==', currentUser.uid).onSnapshot(s => {
             entries = s.docs.map(doc => ({ id: doc.id, ...doc.data() }));
             renderAll();
          });
        });
    }

    async function saveEntry() {
      let amtStr = document.getElementById('amtInp').value;
      // Simple Calc Logic
      try { if(/^[0-9+\-*/.() ]+$/.test(amtStr)) amtStr = eval(amtStr); } catch(e){}
      
      const amt = parseFloat(amtStr);
      const note = document.getElementById('noteInp').value;
      const type = document.getElementById('typeSel').value;

      if (!amt || amt <= 0) return alert("Sahi amount daalein!");

      const data = {
        userId: currentUser.uid,
        amount: amt,
        note: note || 'General',
        type: type,
        date: new Date().toLocaleString('en-IN', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' }),
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      if (editingItem) {
        await db.collection('user_hisab').doc(editingItem).update(data);
      } else {
        await db.collection('user_hisab').add(data);
      }
      closeModal();
    }

    async function deleteEntry(id) {
      if(confirm("Delete karein?")) await db.collection('user_hisab').doc(id).delete();
    }

    function openEdit(id) {
      const item = entries.find(e => e.id === id);
      if(!item) return;
      editingItem = id;
      document.getElementById('modalTitle').textContent = 'Edit Entry';
      document.getElementById('typeSel').value = item.type;
      document.getElementById('amtInp').value = item.amount;
      document.getElementById('noteInp').value = item.note;
      document.getElementById('modalAdd').style.display = 'flex';
    }

    // --- UI RENDERING ---
    function renderAll() {
      const listIn = document.getElementById('listIn');
      const listOut = document.getElementById('listOut');
      listIn.innerHTML = ''; listOut.innerHTML = '';
      
      let tin = 0, tout = 0;

      entries.forEach(e => {
        const html = `
          <div class="tile ${e.type}">
            <div style="flex:1">
              <div class="amount">‚Çπ${e.amount.toLocaleString()}</div>
              <div class="note">${e.note}</div>
              <div class="meta"><small>${e.date}</small></div>
            </div>
            <div style="display:flex; flex-direction:column; gap:5px">
              <button class="iconBtn" onclick="openEdit('${e.id}')">‚úèÔ∏è</button>
              <button class="iconBtn" onclick="deleteEntry('${e.id}')">üóëÔ∏è</button>
            </div>
          </div>`;
        
        if (e.type === 'in') {
          tin += e.amount; listIn.insertAdjacentHTML('beforeend', html);
        } else {
          tout += e.amount; listOut.insertAdjacentHTML('beforeend', html);
        }
      });

      document.getElementById('sumIn').textContent = '‚Çπ' + tin.toLocaleString();
      document.getElementById('sumOut').textContent = '‚Çπ' + tout.toLocaleString();
      document.getElementById('sumBal').textContent = '‚Çπ' + (tin - tout).toLocaleString();
      document.getElementById('balanceAmt').textContent = '‚Çπ' + (tin - tout).toLocaleString();
      
      const total = (tin + tout) || 1;
      document.getElementById('ratioIn').style.width = (tin/total*100) + '%';
      document.getElementById('ratioOut').style.width = (tout/total*100) + '%';

      updateChart(tin, tout);
    }

    function updateChart(tin, tout) {
      const ctx = document.getElementById('chartSmall').getContext('2d');
      if (myChart) myChart.destroy();
      myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          datasets: [{ data: [tin, tout], backgroundColor: ['#24c28b', '#ff6b6b'], borderWidth: 0 }]
        },
        options: { cutout: '75%', plugins: { legend: { display: false } } }
      });
    }

    // --- HELPERS ---
    function openAdd(type) {
      editingItem = null;
      document.getElementById('modalTitle').textContent = 'Add Entry';
      document.getElementById('typeSel').value = type;
      document.getElementById('amtInp').value = '';
      document.getElementById('noteInp').value = '';
      document.getElementById('modalAdd').style.display = 'flex';
    }
    function closeModal() { document.getElementById('modalAdd').style.display = 'none'; }
    function navigate(p) {
      if(p==='in') { document.getElementById('page-in').classList.remove('hidden'); document.getElementById('page-out').classList.add('hidden'); }
      else { document.getElementById('page-out').classList.remove('hidden'); document.getElementById('page-in').classList.add('hidden'); }
    }
    function tickTime() { document.getElementById('appTime').textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
    setInterval(tickTime, 1000); tickTime();

    function exportPDF() {
      const element = document.querySelector('.container');
      const opt = { margin: 10, filename: 'Hisab_Prem_Cloud.pdf', html2canvas: { scale: 2, backgroundColor: '#071117' }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
      html2pdf().set(opt).from(element).save();
    }
  </script>
</body>
</html>
