<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
  <title>HISAB PREM — Mobile Pro</title>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    /* AAPKA ORIGINAL CSS (UNTOUCHED) */
    :root{ --bg:#071117; --card:#0b1113; --accent:#1e6bf0; --green:#24c28b; --red:#ff6b6b; --muted:#98a2a6; --text:#eaf2f5; }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    body{margin:0; font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); overflow-x:hidden;}
    
    .appbar{display:flex; align-items:center; padding:15px; background:linear-gradient(90deg,var(--accent),#1e88e5); position:sticky; top:0; z-index:1000;}
    .logo svg{width:40px; height:40px;}
    .container{max-width:600px; margin:0 auto; padding:15px;}
    
    .card{background:rgba(255,255,255,0.03); border-radius:15px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.5); margin-bottom:20px;}
    .balanceAmt{font-size:32px; font-weight:800; margin:10px 0;}
    
    /* MOBILE OPTIMIZED GRAPH */
    .chartWrap{width:100%; display:flex; justify-content:center; padding:15px 0;}
    #chartSmall{max-width:250px !important; max-height:250px !important;}

    .summary{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:15px;}
    .box{background:rgba(255,255,255,0.05); padding:12px; border-radius:10px; font-size:12px; font-weight:700; text-align:center;}
    
    .tile{display:flex; justify-content:space-between; padding:15px; background:#0d161a; border-radius:12px; margin-bottom:12px; border-left:5px solid var(--accent);}
    .tile.in{border-left-color:var(--green);}
    .tile.out{border-left-color:var(--red);}
    
    .iconBtn{width:35px; height:35px; border-radius:8px; background:rgba(255,255,255,0.05); border:none; color:var(--muted); margin-left:8px;}

    /* FLOATING BUTTON FOR MOBILE */
    .fab{position:fixed; right:20px; bottom:20px; width:65px; height:65px; border-radius:50%; background:var(--green); color:#000; font-size:30px; border:none; box-shadow:0 10px 25px rgba(0,0,0,0.4); z-index:999;}

    /* MODAL FIXED FOR KEYBOARD */
    .modal{display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); align-items:flex-end; z-index:2000;}
    .modalCard{width:100%; background:#0d161a; border-radius:25px 25px 0 0; padding:25px; animation: slideUp 0.3s ease;}
    @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
    
    .input{width:100%; padding:15px; margin-top:10px; border-radius:10px; border:1px solid #222; background:#000; color:#fff; font-size:16px;}

    /* LOGIN SCREEN */
    #loginOverlay{position:fixed; inset:0; background:var(--bg); z-index:5000; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px;}
    .loginBtn{width:100%; max-width:300px; padding:18px; border-radius:15px; border:none; background:#fff; font-weight:800; font-size:16px; margin-top:30px;}
    
    .hidden{display:none !important;}
  </style>
</head>
<body>

  <div id="loginOverlay">
    <h1 style="font-weight:900; font-size:40px; color:var(--accent);">HISAB PREM</h1>
    <p style="color:var(--muted);">Secure Cloud Accounting</p>
    <button class="loginBtn" onclick="googleLogin()">Login with Google</button>
  </div>

  <div id="appMain" class="hidden">
    <div class="appbar">
      <div class="title">HISAB PREM</div>
      <div id="appTime" style="margin-left:auto; font-size:12px;">--:--</div>
      <button onclick="googleLogout()" style="margin-left:15px; background:none; border:1px solid #fff; color:#fff; padding:4px 8px; border-radius:5px; font-size:10px;">Logout</button>
    </div>

    <div class="container">
      <div class="card">
        <div class="balanceTitle" style="font-size:14px; color:var(--muted);">Net Balance</div>
        <div id="balanceAmt" class="balanceAmt">₹0</div>
        
        <div class="summary">
          <div class="box">IN<br><span id="sumIn" style="color:var(--green)">₹0</span></div>
          <div class="box">OUT<br><span id="sumOut" style="color:var(--red)">₹0</span></div>
          <div class="box">SAVE<br><span id="sumBal">₹0</span></div>
        </div>

        <div class="chartWrap">
          <canvas id="chartSmall"></canvas>
        </div>
        
        <button id="exportBtn" style="width:100%; padding:12px; border-radius:10px; background:rgba(255,255,255,0.05); border:1px solid #333; color:#fff; font-weight:700; margin-top:10px;">Download PDF Report</button>
      </div>

      <div id="transactionList" style="padding-bottom:100px;"></div>
    </div>

    <button class="fab" onclick="openModal()">+</button>
  </div>

  <div class="modal" id="modalAdd">
    <div class="modalCard">
      <h3 id="modalTitle" style="margin:0 0 15px 0;">Add Entry</h3>
      <select id="typeSel" class="input">
        <option value="in">Cash In (+)</option>
        <option value="out">Cash Out (-)</option>
      </select>
      <input id="amtInp" class="input" type="text" inputmode="decimal" placeholder="Amount (e.g. 500+200)">
      <input id="noteInp" class="input" type="text" placeholder="Note / Remark">
      
      <div style="display:flex; gap:10px; margin-top:20px;">
        <button onclick="saveEntry()" style="flex:2; padding:18px; border-radius:15px; border:none; background:var(--green); font-weight:800; font-size:16px;">SAVE RECORD</button>
        <button onclick="closeModal()" style="flex:1; padding:18px; border-radius:15px; border:none; background:#222; color:#fff;">BACK</button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA_prff3ZJmhtt_I2RFfbfJsuym-29O7ng",
      authDomain: "hisabprem.firebaseapp.com",
      projectId: "hisabprem",
      storageBucket: "hisabprem.firebasestorage.app",
      messagingSenderId: "299571413492",
      appId: "1:299571413492:web:de65e2a8d3544060fcb9a1"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let entries = [];
    let editingId = null;
    let myChart = null;

    // --- MOBILE LOGIN FIX ---
    function googleLogin() {
      const provider = new firebase.auth.GoogleAuthProvider();
      // Mobile par Popup block hota hai, isliye Redirect use kar rahe hain
      auth.signInWithRedirect(provider);
    }

    function googleLogout() { if(confirm("Logout?")) auth.signOut().then(()=>location.reload()); }

    auth.onAuthStateChanged(user => {
      if(user) {
        document.getElementById('loginOverlay').classList.add('hidden');
        document.getElementById('appMain').classList.remove('hidden');
        loadData(user.uid);
      }
    });

    // --- DATA LOAD ---
    function loadData(uid) {
      db.collection('records').where('uid', '==', uid)
        .onSnapshot(snap => {
          entries = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
          entries.sort((a,b) => b.ts - a.ts);
          renderUI();
        }, err => {
          alert("Firestore Error: " + err.message + "\n\nTip: Make sure Firestore Rules are set to Public.");
        });
    }

    // --- SAVE ENTRY (FIXED) ---
    async function saveEntry() {
      let rawAmt = document.getElementById('amtInp').value;
      let finalAmt = 0;
      try { finalAmt = eval(rawAmt.replace(/[^-()\d/*+.]/g, '')); } catch(e) { alert("Invalid Amount"); return; }
      
      if(!finalAmt || finalAmt <= 0) return;

      const payload = {
        uid: auth.currentUser.uid,
        amount: Number(finalAmt),
        note: document.getElementById('noteInp').value || "General",
        type: document.getElementById('typeSel').value,
        ts: Date.now(),
        date: new Date().toLocaleString()
      };

      try {
        if(editingId) {
          await db.collection('records').doc(editingId).update(payload);
          editingId = null;
        } else {
          await db.collection('records').add(payload);
        }
        closeModal();
      } catch(err) {
        alert("Save Failed: " + err.message);
      }
    }

    // --- RENDER UI ---
    function renderUI() {
      const list = document.getElementById('transactionList');
      list.innerHTML = '';
      let tin = 0, tout = 0;

      entries.forEach(e => {
        if(e.type === 'in') tin += e.amount; else tout += e.amount;
        list.innerHTML += `
          <div class="tile ${e.type}">
            <div>
              <div style="font-weight:800; font-size:18px;">₹${e.amount.toLocaleString()}</div>
              <div style="font-size:13px; color:var(--muted); margin-top:4px;">${e.note}</div>
              <div style="font-size:10px; opacity:0.5; margin-top:4px;">${e.date}</div>
            </div>
            <div style="display:flex;">
              <button class="iconBtn" onclick="openEdit('${e.id}')">✎</button>
              <button class="iconBtn" onclick="deleteEntry('${e.id}')">✕</button>
            </div>
          </div>`;
      });

      document.getElementById('sumIn').textContent = '₹' + tin.toLocaleString();
      document.getElementById('sumOut').textContent = '₹' + tout.toLocaleString();
      document.getElementById('sumBal').textContent = '₹' + (tin - tout).toLocaleString();
      document.getElementById('balanceAmt').textContent = '₹' + (tin - tout).toLocaleString();

      updateChart(tin, tout);
    }

    function updateChart(tin, tout) {
      const ctx = document.getElementById('chartSmall').getContext('2d');
      if(myChart) myChart.destroy();
      myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          datasets: [{ data: [tin, tout], backgroundColor: ['#24c28b', '#ff6b6b'], borderWidth: 0 }]
        },
        options: { cutout: '80%', plugins: { legend: { display: false } } }
      });
    }

    // --- HELPERS ---
    function openModal() { 
      editingId = null; 
      document.getElementById('amtInp').value = '';
      document.getElementById('noteInp').value = '';
      document.getElementById('modalAdd').style.display = 'flex'; 
    }
    function closeModal() { document.getElementById('modalAdd').style.display = 'none'; }
    function deleteEntry(id) { if(confirm("Delete?")) db.collection('records').doc(id).delete(); }
    function openEdit(id) {
      const e = entries.find(x => x.id === id);
      editingId = id;
      document.getElementById('amtInp').value = e.amount;
      document.getElementById('noteInp').value = e.note;
      document.getElementById('typeSel').value = e.type;
      document.getElementById('modalAdd').style.display = 'flex';
    }

    setInterval(() => {
      document.getElementById('appTime').textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }, 1000);
  </script>
</body>
</html>
